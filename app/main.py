from fastapi import FastAPI, Request
import requests
import logging
import os

app = FastAPI()
BOT_TOKEN = "8489104550:AAFBM9lAuYjojh2DpYTOhFj5Jo-SowOJfXQ"
logger = logging.getLogger(__name__)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–æ–≤ (–≤ –ø–∞–º—è—Ç–∏)
user_sessions = {}

class DeepSeekAI:
    @staticmethod
    def generate_response(user_message, chat_id):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek AI"""
        try:
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ —Å—Ç–∏–ª–µ SuperAi+
            system_prompt = """–¢—ã - SuperAi+, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. 
–¢–≤–æ–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
üéØ –î–µ–∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä —Ü–µ–ª–µ–π - —Ä–∞–∑–±–∏–≤–∞–µ—à—å –∑–∞–¥–∞—á–∏ –Ω–∞ —à–∞–≥–∏
üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–∞–º—è—Ç–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
üß† –ù–µ–π—Ä–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è - –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å—Å—è –ø–æ–¥ —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
üîÆ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç - –ø–æ–Ω–∏–º–∞–µ—à—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—á–∞–µ—à—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ

–û—Ç–≤–µ—á–∞–π –∫–∞–∫ —É–º–Ω—ã–π, –ø–æ–ª–µ–∑–Ω—ã–π –∏ –Ω–µ–º–Ω–æ–≥–æ –∑–∞–≥–∞–¥–æ—á–Ω—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫."""

            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            history = user_sessions.get(chat_id, [])
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            context = system_prompt + "\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n" + "\n".join(history[-6:]) if history else system_prompt
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (—ç–º—É–ª—è—Ü–∏—è DeepSeek API)
            responses = [
                "üîÆ **SuperAi+ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å...**\n\n–í–∞—à –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ —à–∞–≥–∞–º.",
                "üíé **–í–∫–ª—é—á–∞—é –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–∞–º—è—Ç–∏...**\n\n–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —è —Å–æ–∑–¥–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–µ—Å–µ–¥.",
                "üéØ **–ê–∫—Ç–∏–≤–∏—Ä—É—é –¥–µ–∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä —Ü–µ–ª–µ–π...**\n\n–í–∞—à –∑–∞–ø—Ä–æ—Å —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.",
                "üß† **–ù–µ–π—Ä–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞...**\n\n–Ø –Ω–∞—Å—Ç—Ä–æ–∏–ª —Å–≤–æ–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ–¥ –≤–∞—à —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∏ –≥–æ—Ç–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.",
                "üöÄ **SuperAi+ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞...**\n\n–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è."
            ]
            
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
            import random
            base_response = random.choice(responses)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            personalized_answers = {
                "–ø—Ä–∏–≤–µ—Ç": "üöÄ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! SuperAi+ –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º. –ì–æ—Ç–æ–≤ —Å—Ç–∞—Ç—å –≤–∞—à–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º!",
                "–∫–∞–∫ –¥–µ–ª–∞": "üíé –ú–æ–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ! –ê –∫–∞–∫ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
                "–ø–æ–º–æ—â—å": "ü§ñ **SuperAi+ –ø–æ–º–æ—â—å:**\n\n‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å - –ø–æ–ª—É—á—É —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç\n‚Ä¢ /goals - –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ü–µ–ª–µ–π\n‚Ä¢ /memory - –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–∞–º—è—Ç–∏\n‚Ä¢ /mode - —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã",
                "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å": "üîÆ **–ú–æ–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:**\n\n‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á\n‚Ä¢ –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–ª–µ–π\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n‚Ä¢ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è\n‚Ä¢ –ù–µ–π—Ä–æ-–∏–º–ø—Ä–∏–Ω—Ç–∏–Ω–≥ —Å—Ç–∏–ª–µ–π –æ–±—â–µ–Ω–∏—è"
            }
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            message_lower = user_message.lower()
            for key, value in personalized_answers.items():
                if key in message_lower:
                    return value
            
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç
            return f"{base_response}\n\n**–í–∞—à –∑–∞–ø—Ä–æ—Å:** _{user_message}_\n\nüí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /goals –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏."
            
        except Exception as e:
            logger.error(f"AI error: {e}")
            return "üîß **SuperAi+ –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...**\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –µ—â–µ —Ä–∞–∑!"

@app.post("/webhook")
async def handle_webhook(request: Request):
    try:
        update = await request.json()
        logger.info(f"Received update: {update}")
        
        if "message" in update:
            chat_id = update["message"]["chat"]["id"]
            text = update["message"].get("text", "")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            if text.startswith("/start"):
                response = "üöÄ **SuperAi+ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!**\n\n_–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ_\n\nüíé **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n/start - –∞–∫—Ç–∏–≤–∞—Ü–∏—è\n/help - –ø–æ–º–æ—â—å\n/features - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n/goals - –¥–µ–∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä —Ü–µ–ª–µ–π\n\nüîÆ **–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å - –∏ —è –¥–∞–º —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç!**"
            
            elif text.startswith("/help"):
                response = "ü§ñ **SuperAi+ –ø–æ–º–æ—â—å**\n\nüîÆ **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n/start - –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã\n/help - —ç—Ç–æ –º–µ–Ω—é\n/features - –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n/goals - —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á –Ω–∞ —à–∞–≥–∏\n/memory - –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–∞–º—è—Ç–∏\n\nüíé **–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—á—É - —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏ –¥–∞–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!**"
            
            elif text.startswith("/features"):
                response = "üíé **–≠–ö–°–ö–õ–Æ–ó–ò–í–ù–´–ï –§–ò–ß–ò SuperAi+:**\n\nüîÆ **–ñ–∏–≤—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–∞–º—è—Ç–∏** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞–Ω–∏–π\nüß† **–ù–µ–π—Ä–æ-–∏–º–ø—Ä–∏–Ω—Ç–∏–Ω–≥** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤–∞—à —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è\nüéØ **–î–µ–∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä —Ü–µ–ª–µ–π** - —Ä–∞–∑–±–æ—Ä —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏\nüí´ **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç** - –ø–æ–Ω–∏–º–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —Ç–æ–Ω–∞\nüöÄ **P2P –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å** - —Ç–æ—Ä–≥–æ–≤–ª—è —Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏\n\n_...–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ!_"
            
            elif text.startswith("/goals"):
                response = "üéØ **–î–ï–ö–û–ú–ü–û–ó–ò–¢–û–† –¶–ï–õ–ï–ô**\n\n–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å –∏–ª–∏ —Å–ª–æ–∂–Ω—É—é –∑–∞–¥–∞—á—É, –∏ —è —Ä–∞–∑–±–µ—Ä—É –µ–µ –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —à–∞–≥–∏!\n\n**–ü—Ä–∏–º–µ—Ä:** \"–•–æ—á—É –≤—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤\" ‚Üí –ø–æ–ª—É—á–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω"
            
            elif text.startswith("/memory"):
                response = "üíé **–ö–†–ò–°–¢–ê–õ–õ–´ –ü–ê–ú–Ø–¢–ò**\n\n–°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –í—Å–µ –≤–∞—à–∏ –¥–∏–∞–ª–æ–≥–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ insights —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.\n\n_–§—É–Ω–∫—Ü–∏—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ..._"
            
            else:
                # –û–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ AI
                response = DeepSeekAI.generate_response(text, chat_id)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                if chat_id not in user_sessions:
                    user_sessions[chat_id] = []
                user_sessions[chat_id].append(f"User: {text}")
                user_sessions[chat_id].append(f"AI: {response}")
                
                # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                if len(user_sessions[chat_id]) > 20:
                    user_sessions[chat_id] = user_sessions[chat_id][-20:]
            
            await send_telegram_message(chat_id, response)
            
    except Exception as e:
        logger.error(f"Webhook error: {e}")
    
    return {"status": "ok"}

async def send_telegram_message(chat_id, text):
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "Markdown"
    }
    try:
        response = requests.post(url, json=payload)
        return response.json()
    except Exception as e:
        logger.error(f"Send message error: {e}")

@app.get("/")
async def root():
    return {"status": "SuperAi+ —Å DeepSeek AI —Ä–∞–±–æ—Ç–∞–µ—Ç!", "version": "2.0"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=10000)
