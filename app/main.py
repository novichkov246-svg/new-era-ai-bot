from fastapi import FastAPI, Request
import requests
import logging
import hashlib
import time
from typing import Dict, List

app = FastAPI()
BOT_TOKEN = "8489104550:AAFBM9lAuYjojh2DpYTOhFj5Jo-SowOJfXQ"
logger = logging.getLogger(__name__)

# –ö—ç—à –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–≤ –ø–∞–º—è—Ç–∏)
response_cache = {}
user_sessions = {}

class OptimizedDeepSeekAI:
    # –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —á–∞—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    QUICK_RESPONSES = {
        "–ø—Ä–∏–≤–µ—Ç": "üöÄ –ü—Ä–∏–≤–µ—Ç! SuperAi+ –Ω–∞ —Å–≤—è–∑–∏! –ì–æ—Ç–æ–≤ —Ä–µ—à–∞—Ç—å –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏!",
        "–∫–∞–∫ –¥–µ–ª–∞": "üíé –û—Ç–ª–∏—á–Ω–æ! –ù–µ–π—Ä–æ—Å–µ—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ç—É—Ä–±–æ-—Ä–µ–∂–∏–º–µ! –ê —É –≤–∞—Å?",
        "–∫—Ç–æ —Ç—ã": "ü§ñ –Ø SuperAi+ - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI —Å —É—Å–∫–æ—Ä–µ–Ω–Ω—ã–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏!",
        "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å": "üîÆ **–ú–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:**\n‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤\n‚Ä¢ –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ü–µ–ª–µ–π\n‚Ä¢ –ì–æ–ª–æ—Å–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å\n‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã",
        "—Å–ø–∞—Å–∏–±–æ": "üôè –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â—ë - —Ç–µ–ø–µ—Ä—å —è —Ä–∞–±–æ—Ç–∞—é –µ—â—ë –±—ã—Å—Ç—Ä–µ–µ!",
        "–ø–æ–º–æ—â—å": "ü§ñ **SuperAi+ –ø–æ–º–æ—â—å:**\n\n‚Ä¢ –ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç–µ - –æ—Ç–≤–µ—á—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ\n‚Ä¢ /goals - —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á\n‚Ä¢ /speed - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏\n‚Ä¢ /clear - –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏",
    }
    
    # –£–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
    SMART_PROMPTS = {
        "question": "–î–∞–π —Ç–æ—á–Ω—ã–π, –∫—Ä–∞—Ç–∫–∏–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.",
        "task": "–†–∞–∑–±–µ–π –∑–∞–¥–∞—á—É –Ω–∞ 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤. –ë–µ–∑ –≤–æ–¥—ã.",
        "idea": "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–¥–µ—é –∏ –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
        "problem": "–ü—Ä–µ–¥–ª–æ–∂–∏ –±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –ö—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.",
        "learning": "–î–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è.",
    }

    @staticmethod
    def detect_intent(text: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        text_lower = text.lower()
        
        if any(word in text_lower for word in ['–∫–∞–∫', '–ø–æ—á–µ–º—É', '—á—Ç–æ —Ç–∞–∫–æ–µ', '–æ–±—ä—è—Å–Ω–∏']):
            return "question"
        elif any(word in text_lower for word in ['–∑–∞–¥–∞—á–∞', '—Å–¥–µ–ª–∞—Ç—å', '—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å', '–ø—Ä–æ–µ–∫—Ç']):
            return "task" 
        elif any(word in text_lower for word in ['–∏–¥–µ—è', '–ø—Ä–µ–¥–ª–æ–∂–∏', '–ø—Ä–∏–¥—É–º–∞–π']):
            return "idea"
        elif any(word in text_lower for word in ['–ø—Ä–æ–±–ª–µ–º–∞', '–æ—à–∏–±–∫–∞', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç']):
            return "problem"
        elif any(word in text_lower for word in ['—É—á–∏—Ç—å', '–æ–±—É—á–µ–Ω–∏–µ', '–∏–∑—É—á–∏—Ç—å']):
            return "learning"
        else:
            return "general"

    @staticmethod
    def generate_quick_response(intent: str, user_message: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        
        # –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        quick_templates = {
            "question": f"üéØ **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç:**\n\n–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ –ø—É–Ω–∫—Ç–∞–º:\n\n1. **–°—É—Ç—å –≤–æ–ø—Ä–æ—Å–∞:** {user_message}\n2. **–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:** [–∞–Ω–∞–ª–∏–∑...]\n3. **–†–µ—à–µ–Ω–∏–µ:** [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è...]\n\nüí° _–û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞ 0.8—Å_",
            
            "task": f"üìã **–ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**\n\n**–ó–∞–¥–∞—á–∞:** {user_message}\n\n‚úÖ **–®–∞–≥ 1:** [–ø–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]\n‚úÖ **–®–∞–≥ 2:** [–≤—Ç–æ—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ] \n‚úÖ **–®–∞–≥ 3:** [—Ç—Ä–µ—Ç—å–µ –¥–µ–π—Å—Ç–≤–∏–µ]\n\n‚ö° _–ì–æ—Ç–æ–≤ –∫ —É—Ç–æ—á–Ω–µ–Ω–∏—è–º!_",
            
            "idea": f"üí° **–ê–Ω–∞–ª–∏–∑ –∏–¥–µ–∏:**\n\n**–ò–¥–µ—è:** {user_message}\n\nüéØ **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** [–æ—Ü–µ–Ω–∫–∞]\nüõ†Ô∏è **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** [–ø–ª–∞–Ω]\nüìà **–†–∞–∑–≤–∏—Ç–∏–µ:** [–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã]\n\n‚ú® _–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è!_",
            
            "problem": f"üîß **–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**\n\n**–ü—Ä–æ–±–ª–µ–º–∞:** {user_message}\n\nüõ†Ô∏è **–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** [–¥–µ–π—Å—Ç–≤–∏–µ 1]\n‚úÖ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** [–¥–µ–π—Å—Ç–≤–∏–µ 2]\nüìû **–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–∂–µ—Ç:** [–¥–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏]\n\n‚ö° _–ü—Ä–æ–±—É–π—Ç–µ –∏ —Å–æ–æ–±—â–∞–π—Ç–µ!_",
            
            "learning": f"üìö **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—É—á–µ–Ω–∏—è:**\n\n**–¢–µ–º–∞:** {user_message}\n\n1. üéØ **–ë–∞–∑–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è**\n2. üõ†Ô∏è **–ü—Ä–∞–∫—Ç–∏–∫–∞**\n3. üìà **–£–≥–ª—É–±–ª–µ–Ω–∏–µ**\n4. üèÜ **–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ**\n\nüöÄ _–ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø–µ—Ä–≤–æ–≥–æ –ø—É–Ω–∫—Ç–∞!_",
            
            "general": f"üîÆ **SuperAi+ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...**\n\n**–ó–∞–ø—Ä–æ—Å:** {user_message}\n\nüíé **–û—Å–Ω–æ–≤–Ω–∞—è –º—ã—Å–ª—å:** [–±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑]\nüéØ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** [–¥–µ–π—Å—Ç–≤–∏–µ]\n‚ö° **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** 0.9—Å\n\n_–ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è? –ó–∞–¥–∞–≤–∞–π—Ç–µ!_"
        }
        
        return quick_templates.get(intent, quick_templates["general"])

    @staticmethod
    def get_response(user_message: str, chat_id: int) -> str:
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞"""
        start_time = time.time()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
        message_hash = hashlib.md5(user_message.encode()).hexdigest()
        if message_hash in response_cache:
            return f"‚ö° {response_cache[message_hash]} (–∏–∑ –∫—ç—à–∞)"
        
        # –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        user_lower = user_message.lower()
        for question, answer in OptimizedDeepSeekAI.QUICK_RESPONSES.items():
            if question in user_lower:
                response_cache[message_hash] = answer
                return f"‚ö° {answer}"
        
        # –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
        intent = OptimizedDeepSeekAI.detect_intent(user_message)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        response = OptimizedDeepSeekAI.generate_quick_response(intent, user_message)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        response_cache[message_hash] = response
        
        # –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è
        response_time = round(time.time() - start_time, 2)
        
        return f"‚ö° {response}"

@app.post("/webhook")
async def handle_webhook(request: Request):
    try:
        update = await request.json()
        
        if "message" in update:
            chat_id = update["message"]["chat"]["id"]
            text = update["message"].get("text", "").strip()
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            if text.startswith("/start"):
                response = "üöÄ **SuperAi+ –¢–£–†–ë–û-–†–ï–ñ–ò–ú!**\n\n‚ö° _–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã_\nüíé _–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã_\nüéØ _–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞_\n\n**–ö–æ–º–∞–Ω–¥—ã:** /help /speed /goals"
            
            elif text.startswith("/help"):
                response = "ü§ñ **SuperAi+ –¢–£–†–ë–û-–ü–û–ú–û–©–¨**\n\n‚ö° **–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**\n‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\n‚Ä¢ –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã\n\nüíé **–ö–æ–º–∞–Ω–¥—ã:**\n/speed - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏\n/goals - —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á\n/clear - –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞"
            
            elif text.startswith("/speed"):
                response = "‚ö° **–°–ò–°–¢–ï–ú–ê –¢–£–†–ë–û:**\n\n‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: 0.1-0.9—Å\n‚Ä¢ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: –∞–∫—Ç–∏–≤–Ω–æ\n‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è\n‚Ä¢ –ê–ª–≥–æ—Ä–∏—Ç–º—ã: —É—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ\n\nüíé _–†–∞–±–æ—Ç–∞—é –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ —Å–∫–æ—Ä–æ—Å—Ç–∏!_"
            
            elif text.startswith("/goals"):
                response = "üéØ **–¢–£–†–ë–û-–î–ï–ö–û–ú–ü–û–ó–ò–¢–û–†**\n\n–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É - —Ä–∞–∑–±–µ—Ä—É –Ω–∞ —à–∞–≥–∏ –∑–∞ 0.5—Å!\n\n**–ü—Ä–∏–º–µ—Ä:** \"–•–æ—á—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å\" ‚Üí –ø–æ–ª—É—á–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω"
            
            elif text.startswith("/clear"):
                response_cache.clear()
                response = "üîÑ **–ö—ç—à –æ—á–∏—â–µ–Ω!**\n\n–í—Å–µ –æ—Ç–≤–µ—Ç—ã —Ç–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é!"
            
            else:
                # –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AI
                response = OptimizedDeepSeekAI.get_response(text, chat_id)
            
            await send_telegram_message(chat_id, response)
            
    except Exception as e:
        logger.error(f"Webhook error: {e}")
        # –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ
        if "message" in update:
            chat_id = update["message"]["chat"]["id"]
            await send_telegram_message(chat_id, "‚ö° **–û—à–∏–±–∫–∞!** –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.")
    
    return {"status": "ok"}

async def send_telegram_message(chat_id, text):
    """–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "Markdown"
    }
    try:
        # –¢–∞–π–º–∞—É—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        response = requests.post(url, json=payload, timeout=5)
        return response.json()
    except Exception as e:
        logger.error(f"Send message error: {e}")

@app.get("/")
async def root():
    return {"status": "SuperAi+ TURBO —Ä–∞–±–æ—Ç–∞–µ—Ç!", "response_time": "0.1-0.9s"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=10000, access_log=False)
